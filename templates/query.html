<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Culinary Atlas</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/query.css') }}"
    />
    <link
      rel="text/css"
      href="{{ url_for('static', filename='css/query.css') }}"
    />
  </head>
  <body>
    <div class="lines">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <nav>
      <h1>Culinary Atlas</h1>
    </nav>

    <main>
      <div class="loader">
        <div class="inner one"></div>
        <div class="inner two"></div>
        <div class="inner three"></div>
      </div>
      <div class="status-container"></div>
    </main>
  </body>
  <script>
    endpoint = "/api/query/";
    const food = "{{ query }}";

    let status_updates = [
      "Exploring the flavors...",
      "Mapping the ingredients...",
      "Cooking up insights...",
      "Savoring the data...",
      "Analyzing cultural variations...",
      "Discovering global influences...",
    ];

    let messageQueue = [...status_updates];
    let currentIndex = 0;
    let statusInterval;

    function addToQueue(message) {
      // Add message to the end of the queue
      messageQueue.push(message);
    }

    function update_status() {
      const container = document.querySelector(".status-container");

      // Get next message from queue
      if (messageQueue.length > 0) {
        // Remove the old status immediately before adding new one
        const oldStatuses = container.querySelectorAll(".status");
        oldStatuses.forEach((status) => status.remove());

        // Add new status
        let status_div = document.createElement("div");
        status_div.className = "status";
        status_div.innerText = messageQueue[currentIndex % messageQueue.length];
        container.appendChild(status_div);

        currentIndex++;
      }
    }

    // Start the carousel
    update_status();
    statusInterval = setInterval(() => {
      update_status();
    }, 4000);

    async function fetchData() {
      const response = await fetch(
        `${endpoint}?food=${encodeURIComponent(food)}`
      );

      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      while (true) {
        const { value, done } = await reader.read();

        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");


        buffer = lines.pop() || "";

        for (const line of lines) {
          if (!line.trim()) continue;

          try {
            const data = JSON.parse(line);
            console.log("Received data:", data);

            if (data.status === "start") {
              addToQueue("Initializing your culinary journey...");
            } else if (data.stage === "diversification") {
              addToQueue("Discovering cultural variations...");


              if (data.result) {
                try {
                  const dishes = JSON.parse(data.result);
                  if (Array.isArray(dishes) && dishes.length > 0) {
                    addToQueue(`Found ${dishes.length} cultural variations!`);

                    // Add each dish to the queue
                    dishes.forEach((dish, index) => {
                      if (dish.dish_name) {
                        addToQueue(`Considering ${dish.dish_name}...`);
                      }
                    });
                  }
                } catch (e) {
                  console.log("Error parsing dishes:", e);
                }
              }
            } else if (data.stage === "recipes") {
              addToQueue("Gathering recipes from around the world...");
            } else if (data.status === "done") {
              console.log("Done! Redirecting...");
              setTimeout(() => {
                window.location.href =
                  "/load_results/?query=" + encodeURIComponent(food);
              }, 1000);
              return;
            } else if (data.stage && data.status) {
              addToQueue(`${data.stage}: ${data.status}`);
            }
          } catch (e) {
            console.log("Error parsing line:", line, e);
          }
        }
      }
    }

    fetchData();
  </script>
</html>
